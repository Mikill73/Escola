<div class="nome-container">
    <input type="text" class="nome-input" id="chat-nome" placeholder="Seu nome" maxlength="50" value="">
</div>

<div class="chat-container">
    <div class="chat-mensagens" id="chat-mensagens">
        <div class="vazio">Carregando mensagens...</div>
    </div>
    
    <div class="chat-form">
        <textarea class="chat-input" id="chat-input" placeholder="Digite sua mensagem (mÃ¡x. 300 caracteres)" maxlength="300"></textarea>
        <button class="chat-enviar" id="chat-enviar" disabled>Enviar</button>
    </div>
</div>

<script>
    const supabaseUrl = 'https://hzslgydylfheyzurkotd.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6c2xneWR5bGZoZXl6dXJrb3RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NjY0NDgsImV4cCI6MjA3MTA0MjQ0OH0.G9DIdCvM-M4MqSadw4qpc82z6G479tc9moCvpLU7jDQ';
    
    let nomeUsuario = localStorage.getItem('chatNome') || '';
    document.getElementById('chat-nome').value = nomeUsuario;
    
    document.getElementById('chat-nome').addEventListener('input', (e) => {
        nomeUsuario = e.target.value;
        localStorage.setItem('chatNome', nomeUsuario);
        atualizarEstadoBotaoEnviar();
    });
    
    document.getElementById('chat-input').addEventListener('input', () => {
        atualizarEstadoBotaoEnviar();
    });
    
    document.getElementById('chat-enviar').addEventListener('click', enviarMensagem);
    
    document.getElementById('chat-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            enviarMensagem();
        }
    });
    
    function atualizarEstadoBotaoEnviar() {
        const input = document.getElementById('chat-input');
        const enviarBtn = document.getElementById('chat-enviar');
        enviarBtn.disabled = !nomeUsuario.trim() || !input.value.trim();
    }
    
    async function carregarMensagens() {
        try {
            const response = await fetch(`${supabaseUrl}/rest/v1/messages?select=*`, {
                headers: {
                    'apikey': supabaseKey,
                    'Authorization': `Bearer ${supabaseKey}`,
                    'Accept': 'application/json'
                }
            });
            
            const mensagensContainer = document.getElementById('chat-mensagens');
            mensagensContainer.innerHTML = '';
            
            if (!response.ok) throw new Error('Erro ao carregar');
            
            const data = await response.json();
            
            if (data && data.length > 0) {
                data.forEach(mensagem => {
                    const mensagemDiv = document.createElement('div');
                    mensagemDiv.className = 'mensagem';
                    mensagemDiv.innerHTML = `
                        <div class="mensagem-usuario">${mensagem.username}:</div>
                        <div class="mensagem-conteudo">${mensagem.content}</div>
                    `;
                    mensagensContainer.appendChild(mensagemDiv);
                });
                mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
            } else {
                mensagensContainer.innerHTML = '<div class="vazio">Nenhuma mensagem ainda</div>';
            }
        } catch (error) {
            document.getElementById('chat-mensagens').innerHTML = '<div class="vazio">Erro ao carregar mensagens</div>';
        }
    }
    
    async function enviarMensagem() {
        const input = document.getElementById('chat-input');
        const conteudo = input.value.trim();
        if (!nomeUsuario || !conteudo) return;
        
        try {
            const response = await fetch(`${supabaseUrl}/rest/v1/messages`, {
                method: 'POST',
                headers: {
                    'apikey': supabaseKey,
                    'Authorization': `Bearer ${supabaseKey}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({
                    username: nomeUsuario,
                    content: conteudo
                })
            });
            
            if (!response.ok) throw new Error('Erro ao enviar');
            
            input.value = '';
            atualizarEstadoBotaoEnviar();
            await carregarMensagens();
        } catch (error) {
            alert('Erro ao enviar mensagem');
        }
    }
    
    carregarMensagens();
    atualizarEstadoBotaoEnviar();
</script>
